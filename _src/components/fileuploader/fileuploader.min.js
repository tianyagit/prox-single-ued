define([], function(){
	var material = {
		'defaultoptions' : {
			callback : null, //回调函数
			type : 'image',
			isWechat : false, // 是否默认显示微信
			multiple : false, //是否多选
			showType : 3, // 1 微信 2 本地 3 微信本地 都显示
			needType : 3, // 1 返回微信 2 返回本地 3 微信和本地 都行
			global : false,// 是否上传到全局
			dest_dir : '', //目标路径
			otherVal : '', // 文字编辑的时候 编辑框为空字符串的bug
			others : {}, // others { image : {needType : 3 ,showType : 3} 如 : 自动回复 图片 视频  语音的 needType 必须是 1 微信
			uniacid : -1,
			netWorkVideo : false, //是否显示 网络视频
		},
		'init' : function(callback, options) {

			var $this = this;
			$this.options = $.extend({}, $this.defaultoptions, options);
			if ($this.options.type == 'audio') {
				$this.options.type = 'voice';
			}
			$this.options.callback = callback;
			$('#material-Modal').remove();

			var type = $this.options.type;
			var html = $this.buildHtml(type);

			$(document.body).prepend(html);
			$this.modalobj = $('#material-Modal');
			$this.registerSelected();//注册选中事件

			var we7resource = angular.module('we7resource');
			we7resource.value('config',$this.options);
			angular.bootstrap($this.modalobj,['we7resource']);
			$this.modalobj.modal('show');

			return $this.modalobj;
		},

		'show' : function(callback, options) {
			this.init(callback,options);
		},

		// 注册模块选中事件
		'registerSelected' : function() {
			var $this = this;
			$(window).unbind('resource_selected').on('resource_selected',function(event,data){
				$this.finish(data.items);
			});

			$(window).unbind('resource_canceled').on('resource_canceled', function (event, data) {
				$this.modalobj.modal('hide');
			});
		},

		'finish' : function(attachment) {
			var $this = this;
			if ($.isFunction($this.options.callback)) {
				if ($this.options.multiple == false) {

					$this.options.callback(attachment[0]);
				} else {
					$this.options.callback(attachment);
				}
				$this.modalobj.modal('hide');
			}
		},

		'buildHtml' : function(type) {
			var label = 'we7-resource-'+type+'-dialog';
			var modelClass = type;
			if (type == 'icon') {
				modelClass = 'module';// module icon共用一个class
			}
			var dialog = '<div '+label+' class="uploader-modal modal fade '+modelClass+'" id="material-Modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2">'+
				'</div>';
			return dialog;
		}
	}
	return material;
});