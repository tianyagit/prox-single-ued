angular.module("ModuleSpecialApp",["wapeditorApp"]),angular.module("ModuleSpecialApp").controller("MainCtrl",["$scope","$timeout","$uibModal","widget","config","serviceCommon","serviceSetStyle","serviceBase","serviceSpecialBase","serviceSubmit","serviceMultiSubmit","serviceMultiPage","serviceUpwardCompatible","$sanitize",function(n,e,a,t,i,s,o,l,c,r,p,g,u,d){n.modules=[],n.editors=[],n.allPages=i.allPages,n.multipage=i.multipage?i.multipage:[],n.submit={params:{},html:"",multipage:[]},n.isNew=!0,n.allPages&&-1==_.findIndex(n.allPages,{active:!0})&&(n.isNew=!1,n.allPages=[{property:n.allPages,active:!0}]),l.setBaseData("isNew",n.isNew),n.allPages=n.allPages?n.allPages:[{property:[],active:!0}];var v=_.findIndex(n.allPages,{active:!0});for(var m in n.activeModules=-1<v?l.initActiveModules(n.allPages[v].property):[],n.activePageIndex=-1<v?v:0,c.setBaseData("activePageIndex",n.activePageIndex),n.activeItem={},n.activeIndex=0,n.index=n.activeModules.length?s.getMaxScopeIndex(n.allPages)+1:0,l.setBaseData("index",n.index),n.pageLength=_.isEmpty(n.activeModules)?1:n.activeModules[0].params.pageLength?n.activeModules[0].params.pageLength:1,n.isMultiPage=0==n.index||!(1<n.activeModules[s.getHeaderIndex(n.activeModules)].params.pageLength),n.isLongPage=0==n.index||(1<n.activeModules[s.getHeaderIndex(n.activeModules)].params.pageLength||1==n.activeModules[s.getHeaderIndex(n.activeModules)].params.pageLength&&1==n.allPages.length),n.pageLengths={1:1,2:2,3:3,4:4,5:5},n.lineHeights={1:1,1.25:1.25,1.5:1.5,2:2,2.5:2.5},n.fontSizes={12:12,14:14,16:16,18:18,20:20,22:22,24:24,26:26,28:28,30:30,32:32,34:34,36:36,38:38,40:40},c.setBaseData("allPages",n.allPages),c.setBaseData("multipage",n.multipage),l.setBaseData("pageLength",n.pageLength),n.isNew||(n.activeModules=u.compatibility(n.activeModules),void 0===n.activeModules[0].params.pageLength&&(n.activeModules[0].params.pageLength=Math.ceil($(".modules").height()/568)),1<n.activeModules[0].params.pageLength&&(n.pageLength=n.activeModules[0].params.pageLength,n.isMultiPage=!1,n.isLongPage=!0,l.setBaseData("pageLength",n.pageLength),e(function(){$(".app-content").css("height",568*n.pageLength+"px")},100)),e(function(){var t=0,i=height="";$(".modules>div").each(function(){var e=parseInt($(this).attr("index"));if(i=$(this).find("div.ng-scope[ng-controller$='Ctrl']").css("width"),height=$(this).find("div.ng-scope[ng-controller$='Ctrl']").css("height"),0<e){for(var a in n.activeModules)n.activeModules[a].index==e&&(t+=parseInt(n.activeModules[a].marginTop),n.activeModules[a].params.positionStyle.width=parseInt(i),n.activeModules[a].params.positionStyle.height=parseInt(height),n.activeModules[a].params.positionStyle.top=t,n.activeModules[a].positionStyle="position:absolute;width:"+i+";height:"+height+";left:"+n.activeModules[a].params.positionStyle.left+"px;top:"+t+"px;",$(this).find("div[ng-controller]").attr("style",n.activeModules[a].positionStyle));t+=parseInt(height)}a++}),l.setBaseData("activeModules",n.activeModules)},1e3)),n.activeModules)n.activeModules[m].originParams=angular.copy(n.activeModules[m].params);n.$on("serviceBase.editors.update",function(e,a){n.editors=a}),n.$on("serviceBase.activeItem.update",function(e,a){n.activeItem=a}),n.$on("serviceBase.activeModules.update",function(e,a){n.activeModules=a}),n.$on("serviceBase.activeItem.params.update",function(e,a){n.activeItem.params=a}),n.$on("serviceBase.activeItem.animationName.update",function(e,a){n.activeItem.params.animationStyle.animationName=a}),n.$on("serviceBase.activeItem.style.update",function(e,a,t,i,s){n.activeItem.params[a]=t,n.activeItem[a]=i,void 0!==s&&(n.activeItem.transform=s)}),n.$on("updateScope",function(e,a){angular.forEach(a,function(e,a){n[a]=e})}),n.addItem=function(e){l.addItem(e)},n.editItem=function(e){l.editItem(e)},n.deleteItem=function(e){l.deleteItem(e)},n.submit=function(e){n.submit=r.submit(),n.$apply("submit"),$(e.target).parents("form").submit()},n.multiSubmit=function(e){n.submit=p.submit(),n.$apply("submit"),$(e.target).parents("form").submit()},n.init=function(e,a){if(n.modules=l.setModules(e,a),0<n.activeModules.length){var t=[];angular.forEach(n.activeModules,function(e,a){e&&t.push(e.id)})}angular.forEach(n.modules,function(e,a){e.defaultshow&&-1==$.inArray(e.id,t)&&l.addItem(e.id)})},n.setModulePositionStyle=function(e){o.setModulePositionStyle(e)},n.eleAnimationIns=function(e){o.eleAnimationIns(e)},n.savePagePosition=function(){o.savePagePosition(n.activeModules)},n.saveModulePosition=function(){o.saveModulePosition(n.activeItem)},n.changeTextAlign=function(e){o.changeTextAlign(n.activeItem,e)},n.changeBorderWidth=function(){o.changeBorderWidth(n.activeItem)},n.changeInnerHeight=function(){o.changeInnerHeight(n.activeItem)},n.clearModuleStyle=function(){o.clearModuleStyle(n.activeItem)},n.changePageLength=function(e){if(angular.isString(e))if("minus"==e&&1<n.pageLength)e=n.pageLength-1;else{if(!("plus"==e&&n.pageLength<5))return!1;e=n.pageLength+1}var a=o.changePageLength(e,n.activeModules);l.setBaseData("pageLength",parseInt(e)),l.setBaseData("activeModules",a)},n.insertPage=function(){g.insertPage(),n.init(null,["header"])},n.navToPage=function(e){g.navToPage(e),n.activeHeader()},n.removePage=function(e){g.removePage(e),n.activeHeader()},n.copyPage=function(e,a){g.copyPage(e,a),n.activeHeader()},n.changeLock=function(){n.activeItem.params.baseStyle.lock=!n.activeItem.params.baseStyle.lock},n.activeHeader=function(){for(var e in n.activeModules)if("header"==n.activeModules[e].id){n.pageLength=n.activeModules[e].params.pageLength?n.activeModules[e].params.pageLength:1,o.changePageLength(n.pageLength,n.activeModules),l.setBaseData("activeItem",n.activeModules[0]),n.editItem(n.activeModules[e].index);break}},$(".multi-submit").on("click",function(e){n.multiSubmit(e)}),$(".single-submit").on("click",function(e){n.submit(e)}),n.init(null,["header"]),n.activeHeader(),n.$watch("activeItem.params.baseStyle",function(e){e&&o.setModuleBaseStyle(e)},!0),n.$watch("activeItem.params.borderStyle",function(e){e&&o.setModuleBorderStyle(e)},!0),n.$watch("activeItem.params.shadowStyle",function(e){e&&o.setModuleShadowStyle(e)},!0),n.$watch("activeItem.params.animationStyle",function(e){e&&o.setModuleAnimationStyle(e)},!0),n.$watch("activeItem.params.positionStyle",function(e){e&&o.setModulePositionStyle(e)},!0)}]),angular.module("ModuleSpecialApp").controller("SpecialDisplay",["$scope","serviceCopy","config",function(t,i,e){t.pages=e.pages,t.links=e.links,angular.forEach(t.pages,function(e,a){e.copyLink=t.links.appHome+"id="+e.id}),t.success=function(e){e=parseInt(e);var a=$('<span class="label label-success" style="position:absolute;z-index:10"><i class="fa fa-check-circle"></i> 复制成功</span>');i.copySuccess(e,a)}}]),angular.module("ModuleSpecialApp").directive("we7Multipage",function(){return{replace:!0,templateUrl:"directive-multipage-multipage.html"}}),angular.module("ModuleSpecialApp").service("serviceSpecialBase",["$rootScope","serviceBase",function(e,a){var t={},i={activePageIndex:0,isMultiPage:!0,isLongPage:!0,allPages:[],multipage:[]};return t.getBaseData=function(e){return i[e]},t.setBaseData=function(e,a){angular.isObject(e)?angular.forEach(e,function(e,a){i[a]=e}):i[e]=a},t}]),angular.module("ModuleSpecialApp").service("serviceCopy",["$rootScope",function(e){var a={copySuccess:function(e,a){e=parseInt(e),a=a;var t=$("#copy-"+e).next().html();(!t||t.indexOf('<span class="label label-success" style="position:absolute;z-index:10"><i class="fa fa-check-circle"></i> 复制成功</span>')<0)&&$("#copy-"+e).after(a),setTimeout(function(){a.remove()},2e3)}};return a}]),angular.module("ModuleSpecialApp").service("serviceMultiPage",["$rootScope","serviceCommon","serviceBase","serviceSpecialBase",function(p,m,h,g){var u={insertPage:function(){u.saveCurPage();var e=g.getBaseData("allPages"),a=g.getBaseData("activePageIndex");e[a].active=!1,e.push({property:[],active:!0}),$(".app-content").css("height","568px"),a=_.findIndex(e,{active:!0}),h.setBaseData({activeModules:[],pageLength:1}),g.setBaseData({allPages:e,isMultiPage:!0,isLongPage:!1,activePageIndex:a}),p.$broadcast("updateScope",{allPages:e,isMultiPage:!0,isLongPage:!1,pageLength:1,activePageIndex:a,activeModules:[]})},navToPage:function(e){var a=g.getBaseData("activePageIndex");if(a==e)return!1;u.saveCurPage();var t=g.getBaseData("allPages"),i=t[e].property;t[a].active=!1,t[e].active=!0,a=e,h.setBaseData("activeModules",i),h.setBaseData("activeItem",i[0]),g.setBaseData({allPages:t,activePageIndex:a}),p.$broadcast("updateScope",{allPages:t,activePageIndex:a,activeModules:i})},removePage:function(e){var a=[],t=g.getBaseData("allPages"),i=g.getBaseData("multipage");if(1==t.length)return!1;u.saveCurPage(),i.splice(parseInt(e),1);var s=_.clone(t),n=t.length-1-e;for(var o in t=[],s)if(o!=e)switch(n){case 0:parseInt(o)+1==e?(t.push({property:s[o].property,active:!0}),a=s[o].property):t.push({property:s[o].property,active:!1});break;default:o-1==e?(t.push({property:s[o].property,active:!0}),a=s[o].property):t.push({property:s[o].property,active:!1})}activePageIndex=_.findIndex(t,{active:!0}),1==t.length&&(g.setBaseData({isMultiPage:!0,isLongPage:!0}),p.$broadcast("updateScope",{isMultiPage:!0,isLongPage:!0})),h.setBaseData("activeModules",a),g.setBaseData({allPages:t,activePageIndex:activePageIndex}),p.$broadcast("updateScope",{allPages:t,activePageIndex:activePageIndex,activeModules:a})},copyPage:function(e,a){u.saveCurPage();var t=h.getBaseData("index"),i=g.getBaseData("allPages"),s=g.getBaseData("multipage");s.splice(parseInt(e),0,s[e]);var n=angular.copy(i);for(var o in i=[],n)if(o==e){i.push({property:n[o].property,active:!1});var l=angular.copy(n[o].property);for(var c in l)l[c].index=t++;i.push({property:l,active:!0});var r=l}else i.push({property:n[o].property,active:!1});activePageIndex=_.findIndex(i,{active:!0}),h.setBaseData("activeModules",r),h.setBaseData("index",t),g.setBaseData({allPages:i,multipage:s,isMultiPage:!0,isLongPage:!1,activePageIndex:activePageIndex}),a.stopPropagation(),p.$broadcast("updateScope",{allPages:i,isMultiPage:!0,isLongPage:!1,activePageIndex:activePageIndex,activeModules:r})},saveCurPage:function(){var u=h.getBaseData("activeModules"),d=h.getBaseData("pageLength"),e=g.getBaseData("allPages"),a=g.getBaseData("multipage"),t=_.findIndex(e,{active:!0}),v="";$($(".modules").html()).find("div.ng-scope[ng-controller$='Ctrl']").each(function(){var e,a=$(this).parent().parent(),t=_.findIndex(u,{index:parseInt(a.attr("index"))}),i=angular.copy(u[t].params);$(this).find(".js-default-content").remove(),$(this).find(".bar").remove();var s=a.attr("name").toLowerCase();if("header"!=s){var n=$(this).css("top"),o=$(this).css("left"),l=$(this).css("width"),c=$(this).css("height"),r="position:absolute;top:"+n+";left:"+o+";width:"+l+";height:"+c+";";u[t].params.positionStyle.top=parseInt(n),u[t].params.positionStyle.left=parseInt(o),u[t].params.positionStyle.width=parseInt(l),u[t].params.positionStyle.height=parseInt(c),u[t].positionStyle=r}else u[t].params.pageLength=d;switch(s){case"link":var p=this;angular.forEach(i.items,function(e,a){(e.selectCate.pid||e.selectCate.cid)&&$(p).find(".list-group").children().eq(a).replaceWith("<div>"+m.buildDataTagBegin("link",e)+'<div class="list-group-item ng-scope"><a href="{$row[url]}" class="clearfix"><span class="app-nav-title"> {$row[title]}<i class="pull-right fa fa-angle-right"></i></span></a></div>'+m.buildDataTagEnd()+"</div>")});break;case"richtext":u[t]&&(u[t].params.content="")}if(e=$(this).html(),!h.getBaseData("isNew")){var g=parseInt(n)-64;$(this).css("top",g+"px")}if("header"!=s){r=$(this).attr("style");v+='<div type="'+s+'" style="'+r+'">'+e+"</div>"}}),v=(v=(v=v.replace(/<\!\-\-([^-]*?)\-\->/g,"")).replace(/ ng\-[a-zA-Z-]+=\"[^\"]*\"/g,"")).replace(/ ng\-[a-zA-Z]+/g,""),a[t]=v,e[t].property=u,h.setBaseData("activeModules",u),g.setBaseData({allPages:e,multipage:a}),p.$broadcast("updateScope",{activeModules:u,allPages:e,multipage:a})}};return u}]),angular.module("ModuleSpecialApp").service("serviceMultiSubmit",["serviceCommon","serviceMultiPage","serviceSpecialBase",function(r,p,g){var e={submit:function(e){p.saveCurPage();var t=g.getBaseData("multipage"),i=g.getBaseData("allPages"),s="",n='<section class="u-arrow-bottom" style="bottom: 15%;"><div class="pre-wrap"><div class="pre-box1"><div class="pre1"></div></div><div class="pre-box2"><div class="pre2"></div></div></div></section></div>';for(var a in $.each(t,function(e,a){e+1==t.length?s+=1==i.length?'<div class="pane">'+a+"</div>":'<div class="pane overflowhidden">'+a+"</div>":s+=1==i.length?'<div class="pane">'+a+n:'<div class="pane overflowhidden">'+a+n}),i)for(var o in i[a].property)delete i[a].property[o].originParams,delete i[a].property[o].marginTop;var l={},c=$(".app-content").css("height");return s='<div style="height:'+c+'"><div class="panes">'+s+"</div></div>",l.html=s,l.params=angular.copy(i),l.multipage=t,r.stripHaskey(l.params),l}};return e}]);